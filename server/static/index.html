<html>
<head>
  <meta charset="utf-8">
  <title>Adventure Corp</title>
  <meta name="description" content="Networked-Aframe">
  <link href="css/style.css" rel="stylesheet" type="text/css" media="screen" />

  <script src="https://aframe.io/releases/0.5.0/aframe.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.5/socket.io.min.js"></script>

  <script src="https://rawgit.com/mayognaise/aframe-gif-shader/master/dist/aframe-gif-shader.min.js"></script>
  <script src="https://rawgit.com/mayognaise/aframe-gif-component/master/dist/aframe-gif-component.min.js"></script>

  <script src="easyrtc/easyrtc.js"></script>
  <script src="https://unpkg.com/networked-aframe/dist/networked-aframe.min.js"></script>

  <script src="https://unpkg.com/aframe-randomizer-components@^3.0.1/dist/aframe-randomizer-components.min.js"></script>
  <script src="https://unpkg.com/aframe-particle-system-component@1.0.5/dist/aframe-particle-system-component.min.js"></script>
  <script src="js/spawn-in-circle.component.js"></script>

  <script src="js/savePosition.js"></script>

  <script
  src="https://code.jquery.com/jquery-3.2.1.min.js"
  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
  crossorigin="anonymous"></script>

  <script src="js/menu-ui.js"></script>
  <script src="js/uploadAvatar.js"></script>
  <script src="js/uploadMedia.js"></script>

  <script>
  // Define custom schema for syncing avatar color, set by random-color
  var avatarSchema = {
    template: '#avatar-template',
    components: [
      'position',
      'rotation',
      {
        selector: '.head',
        component: 'material'
      },
      {
        selector: '.avatar-image-class',
        component: 'material'
      }
    ]
  };
  NAF.schemas.add(avatarSchema);

  AFRAME.registerComponent('url', {
    schema: {
      url: {default: ""},
      movedAway: {default: true}
    },
    tick: function (time, timeDelta) {
      var playerPos = document.querySelector('a-scene').querySelector('#player').getAttribute('position');
      if (
        playerPos.x < (this.el.getAttribute('position').x + .5) &&
        playerPos.x > (this.el.getAttribute('position').x - .5) &&
        playerPos.z < (this.el.getAttribute('position').z + .5) &&
        playerPos.z > (this.el.getAttribute('position').z - .5) &&
        this.el.getAttribute('url').movedAway
      ) {
        console.log("PASSED THROUGH IMAGE");
        window.open(this.el.getAttribute('url').url);
        this.el.setAttribute('url', 'movedAway', 'false');
        console.log("moved away: " + this.el.getAttribute('url').movedAway);
      }
      if (!this.el.getAttribute('url').movedAway) {
        if (
          playerPos.x > (this.el.getAttribute('position').x + 2) ||
          playerPos.x < (this.el.getAttribute('position').x - 2) ||
          playerPos.z > (this.el.getAttribute('position').z + 2) ||
          playerPos.z < (this.el.getAttribute('position').z - 2)
        )
        {
          console.log("MOVED AWAY FROM IMAGE");
          this.el.setAttribute('url', 'movedAway', 'true');
        }
      }
    }
  });

  function addImageToScene(src, position, rotation, url) {
    var containerEl = document.createElement('a-entity');
    var entityEl = document.createElement('a-image');
    containerEl.appendChild(entityEl);
    document.querySelector('a-scene').appendChild(containerEl);
    entityEl.setAttribute('visible','true');
    entityEl.setAttribute('position',position);
    entityEl.setAttribute('rotation',rotation);
    entityEl.setAttribute('material', 'src', 'url(' + src + ')');
    entityEl.setAttribute('url', 'url', url);
  }

  NAF.connection.subscribeToDataChannel('imagePlaced', avatarCallback);
  function avatarCallback(senderRtcId, dataType, data) {
    console.log("DATA RECEIVED", senderRtcId, dataType, data);
    var image = JSON.parse(data);
    addImageToScene(image.src, image.position, image.rotation, image.url);
  };
  </script>
</head>
<body>

  <img id="avatar-hud" src="images/gradient.png" />

  <div id="url_input_div">
    <p class="p_input" id="media_input_p"></p>
    <input type="text" placeholder="Enter URL Here" class="url_btns" id="appendedUrl" name="URL" required/>
    <button class="url_btns" onclick="mediaLoader()">Submit</button>

    <button class="url_btns" onClick="mediaLoader()">No Thanks</button>
  </div>

  <div id="menu_div">

    <!--<button name="Expand" class="menu_btn" id="expand_btn">
    <img class="menu_icon" src="ui/icons/expand.png">
  </button>

  <button name="Collapse" class="menu_btn exp" id="collapse_btn">
  <img class="menu_icon" src="ui/icons/collapse.png">
</button>-->

<button name="Save Location" class="menu_btn exp" id="savelocationbutton" onclick="savePosition()">
  <img class="menu_icon" src="ui/icons/location.png" style="filter: invert(100%);">
</button>

<input type="file" class="upload" id="media_input" style="display:none" single>
<button name="Add Media" class="menu_btn exp" id="addmedia_btn" onClick="uploadMedia()">
  <img class="menu_icon" src="ui/icons/addmedia.png">
</button>

<input type="file" class="upload" id="avatar_input" style="display:none" single>
<button name="Upload Avatar" class="menu_btn exp" id="avatar_menu_btn" onClick="uploadAvatar()">
  <img class="menu_icon" src="ui/icons/addavatar.png">
</button>

<button name="VR Mode" class="menu_btn" id="enter_vr">
  <img class="menu_icon" src="ui/icons/cardboard.png">
</button>

</div>


<a-scene networked-scene="
room: basic;
debug: true;
" vr-mode-ui="enabled: false">
<a-assets>

  <img id="grid" src="https://img.gs/bbdkhfbzkk/stretch/https://i.imgur.com/25P1geh.png" crossorigin="anonymous">
  <img id="sky" src="images/underwater.jpg" crossorigin="anonymous" />
  <!--<a-asset-item id="spongebob-obj" src="/models/spongebob/model.obj"></a-asset-item>
  <a-asset-item id="spongebob-mtl" src="/models/spongebob/materials.mtl"></a-asset-item>-->

  <!-- Avatar -->
  <script id="avatar-template" type="text/html">
    <a-entity class="avatar">
      <a-image class="avatar-image-class" material="src: url(images/gradient.png)" scale="5 5 5" position="2 2 2">
      </a-image>
      <!--<a-entity obj-model="obj: #spongebob-obj; mtl: #spongebob-mtl"></a-entity>-->
      <a-sphere class="head"
      color="#5985ff"
      scale="0.45 0.5 0.4"
      random-color
      ></a-sphere>
      <a-entity class="face"
      position="0 0.05 0"
      >
      <a-sphere class="eye"
      color="#efefef"
      position="0.16 0.1 -0.35"
      scale="0.12 0.12 0.12"
      >
      <a-sphere class="pupil"
      color="#000"
      position="0 0 -1"
      scale="0.2 0.2 0.2"
      ></a-sphere>
    </a-sphere>
    <a-sphere class="eye"
    color="#efefef"
    position="-0.16 0.1 -0.35"
    scale="0.12 0.12 0.12"
    >
    <a-sphere class="pupil"
    color="#000"
    position="0 0 -1"
    scale="0.2 0.2 0.2"
    ></a-sphere>
  </a-sphere>
</a-entity>
</a-entity>
</script>

<!-- /Templates -->
</a-assets>

<a-entity id="player" networked="template:#avatar-template;showLocalTemplate:false;" camera spawn-in-circle="radius:3;" position="0 1.3 0" wasd-controls look-controls>
</a-entity>

<a-entity position="0 0 0"
geometry="primitive: plane; width: 10000; height: 10000;" rotation="-90 0 0"
material="src: #grid; repeat: 10000 10000; transparent: true; metalness:0.6; roughness: 0.4; sphericalEnvMap: #sky;"></a-entity>

<a-entity light="color: #ccccff; intensity: 1; type: ambient;" visible=""></a-entity>
<a-entity light="color: #ffaaff; intensity: 1.5" position="5 5 5"></a-entity>

<a-sky src="#sky" rotation="0 -90 0"></a-sky>
<a-entity id="particles" particle-system="preset: snow"></a-entity>
<a-image id="adventurecorp" material="src: url(images/Adventure_Corporation.png)" scale="20 20 20" position="0 7 10" rotation="0 180 0"></a-image>
</a-scene>

<script>
// On mobile remove elements that are resource heavy
var isMobile = AFRAME.utils.device.isMobile();

if (isMobile) {
  var particles = document.getElementById('particles');
  particles.parentNode.removeChild(particles);
}
</script>

<script>
//Add all images from database into the scene
//var images = {};
$.ajax({
  dataType: 'json',
  url: location.protocol + '//' + location.host + location.pathname + 'retrieveImages',
  success: function(data) {
    console.log('success');
    var images = JSON.parse(JSON.stringify(data));
    console.log("numImages = " + images.length);
    for (var i = 0; i < images.length; i++) {
      console.log("image " + i);
      addImageToScene(images[i].src, images[i].position, images[i].rotation, images[i].url);
    }
  }
});
function getUrlParameter(name) {
  name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
  var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
  var results = regex.exec(location.search);
  return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
};
console.log("specifiedPosition: " + getUrlParameter('specLocX'));
if (getUrlParameter('specLocY') != "") {
  var movePos = new THREE.Vector3(getUrlParameter('specLocX'), getUrlParameter('specLocY'), getUrlParameter('specLocZ'));
  var moveRot = new THREE.Vector3(getUrlParameter('specRotX'), getUrlParameter('specRotY'), getUrlParameter('specRotZ'));
  document.querySelector('a-scene').querySelector('#player').setAttribute('position',movePos);
  document.querySelector('a-scene').querySelector('#player').setAttribute('rotation',moveRot);
}
</script>
</body>
</html>
